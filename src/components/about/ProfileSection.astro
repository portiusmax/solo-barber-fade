---
import SectionHeading from '@/components/common/SectionHeading.astro';
import RichText from '@/components/common/RichText.astro';

interface Props {
  heading?: string;
  bio?: any;
  profilePhoto?: string | null;
  secondaryPhoto?: string | null;
  yearsExperience?: number | null;
  certifications?: any;
}

const {
  heading,
  bio,
  profilePhoto,
  secondaryPhoto,
  yearsExperience,
  certifications,
} = Astro.props;
---

<section class="profile section-padding" aria-labelledby="profile-heading">
  <div class="profile-inner container">
    <div class="profile-images reveal">
      {profilePhoto && (
        <div class="profile-photo-wrapper">
          <img
            src={profilePhoto}
            alt="Profile photo"
            class="profile-photo"
            loading="eager"
          />
          {yearsExperience && (
            <div class="experience-badge" aria-label={`${yearsExperience} years of experience`}>
              <span class="experience-number" data-count-to={yearsExperience}>{yearsExperience}</span>
              <span class="experience-label">Years</span>
            </div>
          )}
        </div>
      )}
      {secondaryPhoto && (
        <div class="secondary-photo-wrapper">
          <img
            src={secondaryPhoto}
            alt="At work"
            class="secondary-photo"
            loading="lazy"
          />
        </div>
      )}
    </div>

    <div class="profile-content reveal">
      {heading && (
        <SectionHeading tag="h1" align="left" class="profile-heading">
          {heading}
        </SectionHeading>
      )}
      {bio && <RichText document={bio} class="profile-bio" />}
      {certifications && (
        <div class="certifications">
          <h3 class="certifications-title">Training & Certifications</h3>
          <RichText document={certifications} />
        </div>
      )}
    </div>
  </div>
</section>

<style>
  .profile {
    background-color: var(--color-bg);
  }

  .profile-inner {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2.5rem;
    align-items: start;
  }

  @media (min-width: 768px) {
    .profile-inner {
      grid-template-columns: 1fr 1fr;
      gap: 4rem;
      align-items: center;
    }
  }

  @media (min-width: 1024px) {
    .profile-inner {
      gap: 5rem;
    }
  }

  /* ─── Image Column ─── */
  .profile-images {
    position: relative;
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  .profile-photo-wrapper {
    position: relative;
  }

  .profile-photo {
    width: 100%;
    height: auto;
    aspect-ratio: 4 / 5;
    object-fit: cover;
    border-radius: var(--radius-lg);
    display: block;
  }

  .experience-badge {
    position: absolute;
    bottom: -1rem;
    right: -0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 5.5rem;
    height: 5.5rem;
    border-radius: 50%;
    background-color: var(--color-accent);
    color: white;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    z-index: 2;
  }

  @media (min-width: 768px) {
    .experience-badge {
      bottom: -1.25rem;
      right: -1.25rem;
      width: 6.5rem;
      height: 6.5rem;
    }
  }

  .experience-number {
    font-family: var(--font-heading);
    font-weight: var(--heading-weight);
    font-size: 1.75rem;
    line-height: 1;
    letter-spacing: var(--heading-tracking);
  }

  @media (min-width: 768px) {
    .experience-number {
      font-size: 2rem;
    }
  }

  .experience-label {
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.9;
    margin-top: 0.125rem;
  }

  .secondary-photo-wrapper {
    max-width: 65%;
  }

  .secondary-photo {
    width: 100%;
    height: auto;
    aspect-ratio: 3 / 4;
    object-fit: cover;
    border-radius: var(--radius-lg);
    display: block;
  }

  /* ─── Content Column ─── */
  .profile-content {
    order: -1;
  }

  @media (min-width: 768px) {
    .profile-content {
      order: 0;
    }
  }

  .profile-bio {
    color: var(--color-text);
    font-size: 1.0625rem;
    margin-bottom: 2rem;
  }

  .certifications {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .certifications-title {
    font-size: 1.125rem;
    margin-bottom: 0.75rem;
    color: var(--color-accent);
    text-transform: var(--heading-transform);
    letter-spacing: var(--heading-tracking);
    font-weight: var(--heading-weight);
  }

  /* ═══ FADE: Corner brackets on image, gold accent, elegant badge ═══ */
  :global([data-theme="fade"]) .profile-photo,
  :global([data-theme="fade"]) .secondary-photo {
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
  }

  :global([data-theme="fade"]) .profile-photo-wrapper {
    position: relative;
  }

  :global([data-theme="fade"]) .profile-photo-wrapper::before,
  :global([data-theme="fade"]) .profile-photo-wrapper::after {
    content: '';
    position: absolute;
    width: 2.5rem;
    height: 2.5rem;
    border-color: var(--color-accent);
    border-style: solid;
    pointer-events: none;
    z-index: 3;
  }

  :global([data-theme="fade"]) .profile-photo-wrapper::before {
    top: -0.5rem;
    left: -0.5rem;
    border-width: 1px 0 0 1px;
  }

  :global([data-theme="fade"]) .profile-photo-wrapper::after {
    bottom: 0.5rem;
    right: -0.5rem;
    border-width: 0 1px 1px 0;
  }

  :global([data-theme="fade"]) .experience-badge {
    border-radius: 0.25rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(200, 160, 80, 0.3);
  }

  :global([data-theme="fade"]) .profile-content {
    border-left: 1px solid rgba(200, 160, 80, 0.2);
    padding-left: 2rem;
  }

  :global([data-theme="fade"]) .certifications {
    border-top-color: rgba(200, 160, 80, 0.15);
  }

  /* ═══ CLEAN: Rounded image, big shadow, warm badge ═══ */
  :global([data-theme="clean"]) .profile-photo {
    border-radius: 1.5rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
  }

  :global([data-theme="clean"]) .secondary-photo {
    border-radius: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
  }

  :global([data-theme="clean"]) .experience-badge {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
  }

  :global([data-theme="clean"]) .certifications {
    background-color: var(--color-bg-alt);
    border-radius: 1rem;
    padding: 1.5rem;
    border-top: none;
    margin-top: 2rem;
  }

  /* ═══ CHOP: Grayscale image, thick border, bold badge ═══ */
  :global([data-theme="chop"]) .profile-photo,
  :global([data-theme="chop"]) .secondary-photo {
    border-radius: 0;
    filter: grayscale(100%);
    transition: filter 0.4s ease;
  }

  :global([data-theme="chop"]) .profile-photo:hover,
  :global([data-theme="chop"]) .secondary-photo:hover {
    filter: grayscale(0%);
  }

  :global([data-theme="chop"]) .profile-photo-wrapper {
    border: 2px solid var(--color-heading);
  }

  :global([data-theme="chop"]) .experience-badge {
    border-radius: 0;
    width: 6rem;
    height: 6rem;
    border: 2px solid white;
  }

  @media (min-width: 768px) {
    :global([data-theme="chop"]) .experience-badge {
      width: 7rem;
      height: 7rem;
    }
  }

  :global([data-theme="chop"]) .profile-content {
    border-left: 4px solid var(--color-accent);
    padding-left: 2rem;
  }

  :global([data-theme="chop"]) .certifications {
    border-top: 3px solid var(--color-heading);
  }
</style>

<script>
  function initCounters() {
    const counters = document.querySelectorAll('[data-count-to]');
    if (!counters.length) return;

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (!entry.isIntersecting) return;
        observer.unobserve(entry.target);
        const target = parseInt(entry.target.getAttribute('data-count-to'), 10);

        if (prefersReducedMotion || isNaN(target)) {
          entry.target.textContent = target.toString();
          return;
        }

        entry.target.textContent = '0';
        const duration = 1500;
        const start = performance.now();

        function tick(now) {
          const elapsed = now - start;
          const progress = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 3);
          entry.target.textContent = Math.round(eased * target).toString();
          if (progress < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      });
    }, { threshold: 0.5 });

    counters.forEach((el) => observer.observe(el));
  }

  initCounters();
  document.addEventListener('astro:after-swap', initCounters);
</script>
